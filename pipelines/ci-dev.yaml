steps:
  # Skaffold Build With Artifacts
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args: ["-c", "mkdir outputs"]

  - name: "gcr.io/k8s-skaffold/skaffold:v1.35.0"
    args:
      [
        "skaffold",
        "build",
        "--file-output=./outputs/output-gke_dev-$SHORT_SHA.json",
      ]
    env:
      - "TAG=0.0.1.dev5-rc1"
      - "ENV=dev"

  - name: "gcr.io/cloud-builders/git"
    args: ["clone", "https://github.com/josephoyomikavala/manifest-repo.git"]

  - name: "gcr.io/cloud-builders/git"
    entrypoint: /bin/bash
    args:
      - -c
      - |
        # Cloud Build doesn't recover the .git file. Thus checkout the repo for this
        git clone https://github.com/josephoyomikavala/manifest-repo.git ;
         git config user.email "cloudbuild@gmail.com"
         git config  user.name "Cloud build Process"
        # Copy only the .git file
        # mv manifest-repo/.git .
        cd manifest-repo/templates
        envsubst < application-template.yaml > ../application.yaml
        # ./scripts/update-manifest.sh
        git add . 
        git commit -m "updated Tag" && git push
options:
  logging: CLOUD_LOGGING_ONLY
